- name: Get existing credentials
  uri:
    url: "{{URL}}/credentials/store/system/domain/_/api/json?tree=credentials[id]"
    method: GET
    user: "{{ APP_KEYS.APP_USER }}"
    password: "{{ APP_KEYS.APP_PASS }}"
    force_basic_auth: yes
    follow_redirects: all
  register: credentials

- name : print
  debug:
    msg: items are {{item.id}}
  loop: "{{ credentials.json.credentials }}"

- name: Get Jenkins crumb
  uri:
    url: "https://jenkins.chaitu.net/crumbIssuer/api/json"
    method: GET
    validate_certs: no
  register: crumb

- name: Delete secret
  uri:
    url: "{{ URL }}/credentials/store/system/domain/_/credential/{{ item.id }}/doDelete"
    method: POST
    user: "{{ APP_KEYS.APP_USER }}"
    password: "{{ APP_KEYS.APP_PASS }}"
    headers:
      Jenkins-Crumb: "{{ crumb.json.crumb }}"
    validate_certs: no
    force_basic_auth: yes
    follow_redirects: all
  loop: "{{ credentials.json.credentials }}"